# 한국 경마 데이터 EDA 최종 리포트

**분석 기간**: 2013-2023 (Train Set Only)
**분석 일자**: 2025-10-01
**Look-ahead Bias**: 완전 제거 (Test Set 2024-2025는 절대 사용 안 함)

---

## 📊 목차

1. [데이터셋 개요](#1-데이터셋-개요)
2. [컬럼 설명](#2-컬럼-설명)
3. [기본 통계](#3-기본-통계)
4. [핵심 인사이트](#4-핵심-인사이트)
5. [수익성 분석](#5-수익성-분석)
6. [고배당 예측 신호](#6-고배당-예측-신호)
7. [유망 전략 후보](#7-유망-전략-후보)
8. [다음 단계](#8-다음-단계)

---

## 1. 데이터셋 개요

### 데이터 출처
- **소스**: 한국마사회(KRA) PDF 성적표
- **수집 방법**: PDF 파싱 (2개 버전)
  - 2021-2025: `parse_pdf_complete.py` (칼럼 기반)
  - 2013-2020: `parse_pdf_old_format.py` (행 기반)

### 데이터 규모

| 구분 | 레코드 수 | 기간 | 용도 |
|------|----------|------|------|
| **Train Set** | **53,395개** | 2013-02-22 ~ 2023-12-31 | EDA & 모델링 |
| Test Set | 10,451개 | 2024-01-06 ~ 2025-09-28 | 최종 검증 (미사용) |
| **전체** | **63,846개** | 2013-2025 (12년) | - |

### 데이터 구성

- **경주일**: 873일
- **말**: 8,835마리
- **기수**: 112명
- **조련사**: 711명
- **경주장**: 서울 (주로)

### 연도별 분포

![연도별 데이터 분포](eda_output/6_yearly_trends.png)

**특징**:
- 2013년 첫 데이터 (2,648개)
- 2014-2019년 안정적 (연 5,000-6,500개)
- 2020년 감소 (3,307개, 코로나 영향 추정)
- 2021년 급감 (1,238개, PDF 포맷 변경 + 코로나)
- 2022-2023년 회복 (연 4,500-6,100개)

---

## 2. 컬럼 설명

### 경주 기본 정보

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| `trd_dt` | datetime | 경주일자 | 2023-12-31 |
| `race_no` | Int8 | 경주 번호 (1-12) | 5 |
| `track` | category | 경주장 | 서울 |
| `distance` | Int16 | 거리 (미터) | 1000, 1200, 1400, 1800 |
| `grade` | category | 등급 | 국1등급, 국2등급, ..., 국6등급 |
| `race_type` | category | 경주 구분 | 별정, 핸디캡 |
| `weather` | category | 날씨 | 맑음, 흐림, 비 |
| `track_cond` | category | 주로 상태 | 양호, 다습, 불량, 포화 |
| `track_cond_pct` | float | 주로 함수율 (%) | 12.5 |

### 말 정보

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| `horse_name` | category | 말 이름 | 강한질주 |
| `horse_origin` | category | 산지 | 한, 외, 혼 |
| `horse_sex` | category | 성별 | 수, 암, 거 (거세) |
| `horse_age` | Int8 | 나이 (세) | 2, 3, 4, 5, 6, 7, 8+ |
| `weight` | Int16 | 마체중 (kg) | 480, 520 |
| `weight_change` | Int8 | 증감 (kg) | +5, -3 |

### 기수 & 조련사

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| `jockey_name` | category | 기수 이름 | 문세영, 박재이 |
| `trainer_name` | category | 조련사 이름 | 이준철, 송문길 |

### 경주 조건

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| `gate_no` | Int8 | 게이트 번호 | 1-14 |
| `burden_weight` | float | 부담중량 (kg) | 54.0, 56.0, 58.0 |
| `rating` | float | 레이팅 (2013-2020 없음) | 80.0 |

### 결과

| 컬럼명 | 타입 | 설명 | 예시 |
|--------|------|------|------|
| `finish_pos` | Int8 | 최종 순위 | 1, 2, 3, ..., 14 |
| `finish_time` | float | 주파시간 (초) | 72.5 (= 1:12.5) |
| `margin` | float | 착차 (마신) | 0.5, 2.5, 코(0.1), 목(0.25) |
| `odds_win` | float | 단승 배당 | 2.5배, 10.0배, 50.0배 |
| `odds_place` | float | 복승 배당 | 1.5배, 3.0배, 15.0배 |

### 파생 컬럼 (분석용)

| 컬럼명 | 계산식 | 설명 |
|--------|--------|------|
| `is_top3` | `finish_pos <= 3` | Top 3 여부 (복승) |
| `odds_range` | `pd.cut(odds_win)` | 배당 범위 (1-2x, 2-3x, ..., 50x+) |

---

## 3. 기본 통계

### 3.1 배당 통계

| 지표 | 단승 배당 | 복승 배당 |
|------|----------|----------|
| 평균 | 25.63배 | - |
| 중앙값 | 9.60배 | - |
| 최소 | 1.00배 | - |
| 최대 | 5,466.40배 | - |
| 표준편차 | 높음 (롱테일) | - |

**분포 특징**:
- 극단적 우측 편향 (Long tail)
- 중앙값(9.60배) << 평균(25.63배)
- 50배 이상 고배당: 전체의 14.1% (7,507개)

### 3.2 성적 통계

| 지표 | 비율 | 설명 |
|------|------|------|
| Top 3 (복승) | 23.0% | 전체 평균 |
| 1등 (단승) | 3.6% | 전체 평균 |
| 평균 출전 마릿수 | ~14마리 | 1경주당 |

### 3.3 결측치 현황

주요 결측치 (Train Set 53,395개 기준):

| 컬럼 | 결측치 | 비율 | 원인 |
|------|--------|------|------|
| `rating` | 53,395 | 100% | 2013-2020 PDF에 없음 |
| `weight` | 47,387 | 88.8% | 2013-2020 PDF 파싱 실패 |
| `weight_change` | 47,387 | 88.8% | 동일 |
| `track_cond` | 36,344 | 68.1% | 일부 PDF 누락 |
| `grade` | 36,698 | 68.7% | 일부 PDF 누락 |
| `race_no` | 35,141 | 65.8% | 일부 PDF 파싱 실패 |
| `horse_age` | 21,609 | 40.5% | 2013-2020 일부 누락 |
| `odds_place` | 20,265 | 38.0% | 복승 미발매 경주 |

**핵심 컬럼 결측치** (모델링 필수):
- `odds_win`: 11개 (0.02%) ✓ 거의 완벽
- `jockey_name`: 21,609개 (40.5%)
- `trainer_name`: 21,609개 (40.5%)
- `burden_weight`: 21,609개 (40.5%)

**결론**: 완전한 데이터 ~32,000개 (60%)

---

## 4. 핵심 인사이트

### 4.1 배당과 실제 확률의 관계

![배당 vs Top 3 확률](eda_output/7_odds_vs_top3_scatter.png)

**발견**:
- 시장은 **매우 효율적** (Efficient Market)
- 실제 Top 3 비율 ≈ 이론적 확률 (1/배당)
- 저배당(1-5배): 시장이 약간 **과소평가** (favorable-favorite bias)
- 고배당(20배+): 시장이 약간 **과대평가** (longshot bias)
- **중요**: 배당만으로도 충분히 정확한 예측!

### 4.2 시계열 트렌드

![연도별 트렌드](eda_output/6_yearly_trends.png)

**발견**:
- Top 3 비율: 20-26% 사이에서 안정적
- 평균 배당: 15-30배 사이에서 변동
- 2020-2021년: 코로나 영향으로 데이터 감소
- **중요**: 시계열 패턴이 안정적 → 모델 일반화 가능성 높음

---

## 5. 수익성 분석

### 5.1 배당 범위별 수익성

![배당 범위별 수익성](eda_output/1_odds_range_profitability.png)

**Break-even 공식**:
```
필요 정확도 = 1 / (복승 배당 × 환급률)
환급률 = 80% (마사회 수수료 20%)
```

| 배당 범위 | 전체 | Top 3 | 실제 비율 | 복승배당 | 필요 정확도 | 갭 | 평가 |
|---------|------|-------|----------|---------|------------|-----|------|
| **1-2x** | 5,937 | 3,180 | **53.6%** | 2.80배 | 44.7% | **✓ -8.9%p** | 수익 가능 |
| 2-3x | 4,551 | 1,618 | 35.6% | 1.97배 | 63.6% | +28.0%p | 불가능 |
| 3-5x | 6,843 | 2,101 | 30.7% | 1.94배 | 64.4% | +33.7%p | 불가능 |
| 5-10x | 10,043 | 2,380 | 23.7% | 2.55배 | 49.0% | +25.3%p | 매우 어려움 |
| 10-20x | 9,177 | 1,581 | 17.2% | 3.51배 | 35.6% | +18.4%p | 어려움 |
| 20-50x | 9,340 | 1,037 | 11.1% | 6.03배 | 20.7% | +9.6%p | 어려움 |
| **50x+** | 7,490 | 397 | **5.3%** | 16.86배 | 7.4% | **+2.1%p** | **가장 유망** |

### 5.2 전략 평가

#### ✅ 전략 1: 1-2배 저배당 (현재 수익 가능)

**현황**:
- 실제 Top 3: 53.6%
- 필요: 44.7%
- **이미 수익 가능!** (-8.9%p 여유)

**이론 ROI**:
```
ROI = (53.6% × 2.80 × 0.8) - 100%
    = 120.1% - 100%
    = +20.1%
```

**문제점**:
- 평균 배당 낮음 (2.80배)
- 샘플 크기 작음 (5,937개, 11%)
- 리스크 대비 수익 낮음

**결론**: 보조 전략으로만 활용

---

#### 🎯 전략 2: 50배+ 고배당 (가장 유망)

**현황**:
- 실제 Top 3: 5.3%
- 필요: 7.4%
- **갭: 단 +2.1%p** (가장 적음!)

**이론 ROI** (7.4% 달성 시):
```
ROI = (7.4% × 16.86 × 0.8) - 100%
    = 99.7% - 100%
    ≈ Break-even (0%)
```

**이론 ROI** (9.0% 달성 시):
```
ROI = (9.0% × 16.86 × 0.8) - 100%
    = 121.4% - 100%
    = +21.4% 💰
```

**장점**:
1. **가장 적은 개선 폭**: +2.1%p만 올리면 됨
2. **높은 배당**: 평균 16.86배
3. **충분한 샘플**: 7,490개 (14%)
4. **명확한 신호 존재**: 엘리트 기수/조련사 효과 큼

**결론**: **Primary 타겟**

---

## 6. 고배당 예측 신호

### 6.1 엘리트 기수 (50배+ 기준)

![엘리트 기수](eda_output/2_elite_jockeys_50x.png)

**Top 10** (10회 이상 출전):

| 순위 | 기수 | Top 3 비율 | 출전 | 향상 | 평가 |
|-----|------|-----------|------|------|------|
| 1 | 박재이 | **16.7%** | 12 | **+11.4%p** | ⭐⭐⭐ |
| 2 | 윤태혁 | **15.4%** | 13 | **+10.1%p** | ⭐⭐⭐ |
| 3 | 김덕현 | 13.2% | 38 | +7.9%p | ⭐⭐ |
| 4 | 부민호 | 12.9% | 70 | +7.6%p | ⭐⭐ |
| 5 | 마누엘 | 11.5% | 52 | +6.2%p | ⭐⭐ |
| 6 | 푸르칸 | 10.0% | 10 | +4.7%p | ⭐ |
| 7 | 다나카 | 9.9% | 91 | +4.6%p | ⭐ |
| 8 | 최범현 | 9.8% | 41 | +4.5%p | ⭐ |
| 9 | 김귀배 | 9.7% | 62 | +4.4%p | ⭐ |
| 10 | 황종우 | 9.7% | 31 | +4.4%p | ⭐ |

**베이스라인**: 5.3%

**인사이트**:
- **박재이, 윤태혁**: 베이스라인의 **3배** 성과!
- Top 5 기수: 10%+ 달성 (Break-even 7.4% 초과)
- **중요**: 샘플이 작지만 (10-70회) 명확한 차이

**임계값**: Top 3 비율 **10%+** (베이스라인의 2배)

---

### 6.2 엘리트 조련사 (50배+ 기준)

![엘리트 조련사](eda_output/3_elite_trainers_50x.png)

**Top 10** (10회 이상):

| 순위 | 조련사 | Top 3 비율 | 출전 | 향상 | 평가 |
|-----|--------|-----------|------|------|------|
| 1 | 이준철 | **12.5%** | 16 | **+7.2%p** | ⭐⭐⭐ |
| 2 | 이희영 | **12.2%** | 131 | **+6.9%p** | ⭐⭐⭐ |
| 3 | 송문길 | 10.8% | 102 | +5.5%p | ⭐⭐ |
| 4 | 리카디 | 10.7% | 56 | +5.4%p | ⭐⭐ |
| 5 | 김순근 | 10.7% | 56 | +5.4%p | ⭐⭐ |
| 6 | 박병일 | 10.6% | 132 | +5.3%p | ⭐⭐ |
| 7 | 사이먼 | 10.5% | 19 | +5.2%p | ⭐⭐ |
| 8 | 서홍수 | 8.5% | 153 | +3.2%p | ⭐ |
| 9 | 강성오 | 8.5% | 59 | +3.2%p | ⭐ |
| 10 | 박재우 | 7.5% | 146 | +2.2%p | ⭐ |

**베이스라인**: 5.3%

**인사이트**:
- **이준철, 이희영**: 베이스라인의 **2.3배** 성과!
- Top 7 조련사: 10%+ 달성
- **중요**: 이희영(131회), 박병일(132회) 등 충분한 샘플

**임계값**: Top 3 비율 **10%+**

---

### 6.3 말 나이 (50배+ 기준)

![말 나이](eda_output/4_horse_age_50x.png)

| 나이 | Top 3 비율 | 출전 | 향상 | 평가 |
|-----|-----------|------|------|------|
| **3세** | **5.7%** | 2,492 | +0.4%p | ⭐ |
| **5세** | **5.7%** | 1,054 | +0.4%p | ⭐ |
| 2세 | 5.6% | 1,530 | +0.3%p | ⭐ |
| 6세 | 5.5% | 542 | +0.2%p | - |
| 4세 | 4.9% | 1,479 | -0.4%p | ❌ |
| 7세 | 4.1% | 220 | -1.2%p | ❌ |

**베이스라인**: 5.3%

**인사이트**:
- **젊은 말 (2-3세)**: 약간 유리
- **중년 말 (5세)**: 약간 유리
- **나이든 말 (7세+)**: 불리
- **중요**: 효과 크기 작음 (+0.4%p)

---

### 6.4 부담중량 (50배+ 기준)

![부담중량](eda_output/5_burden_weight_50x.png)

| 부담중량 (kg) | Top 3 비율 | 출전 | 향상 | 평가 |
|--------------|-----------|------|------|------|
| **54-56kg** | **6.4%** | 1,979 | **+1.1%p** | ⭐⭐ |
| 56-58kg | 6.0% | 265 | +0.7%p | ⭐ |
| 52-54kg | 5.1% | 2,953 | -0.2%p | - |
| 45-52kg | 4.7% | 2,216 | -0.6%p | ❌ |

**베이스라인**: 5.3%

**인사이트**:
- **높은 부담중량 (54-58kg)**: 유리 (+1.1%p)
- **낮은 부담중량 (45-52kg)**: 불리 (-0.6%p)
- **역설적**: 고배당인데 높은 부담중량이 유리?
  - **해석**: 부담중량은 말의 능력 반영 → 능력 있는데 배당이 높은 말 = 과소평가

---

### 6.5 게이트 위치 (50배+ 기준)

| 게이트 | Top 3 비율 | 출전 | 향상 |
|--------|-----------|------|------|
| 1-3번 | **6.2%** | 1,681 | +0.9%p |
| 4-6번 | 5.2% | 1,948 | -0.1%p |
| 7-9번 | 5.1% | 2,079 | -0.2%p |
| 10-17번 | 4.8% | 1,799 | -0.5%p |

**인사이트**:
- 안쪽 게이트 (1-3번): 약간 유리 (+0.9%p)
- 효과 크기 작음

---

## 7. 유망 전략 후보

### 🎯 전략 A: 50배+ Rule-based Model (권장)

**목표**: Top 3 Precision **7.4%+** (Break-even)

**신호 조합** (점수 시스템):

| 신호 | 조건 | 점수 | 근거 |
|-----|------|------|------|
| **엘리트 기수** | Top 3 비율 10%+, 10회+ 출전 | **+3점** | +10%p 향상 (가장 강력) |
| **엘리트 조련사** | Top 3 비율 10%+, 10회+ 출전 | **+2점** | +7%p 향상 (강력) |
| **부담중량** | 54-56kg | **+1점** | +1.1%p 향상 |
| **말 나이** | 3-5세 | **+1점** | +0.4%p 향상 |
| **게이트** | 1-3번 | **+1점** | +0.9%p 향상 |

**베팅 규칙**:
```python
if score >= 4:
    베팅 (예상 Top 3 확률 > 7.4%)
else:
    패스
```

**예상 성능**:
- 점수 4점+: 엘리트 기수(3) + 엘리트 조련사(2) + 기타(1) 이상
- 예상 Top 3 비율: **10-15%** (충분히 수익 가능)

**장점**:
- 해석 가능 (Interpretable)
- 과적합 위험 낮음
- 실전 적용 쉬움

---

### 💡 전략 B: 20-50배 중배당 (대안)

**목표**: Top 3 Precision **20.7%+**

**현황**:
- 실제: 11.1%
- 필요: 20.7%
- **갭: +9.6%p** (50x+보다 4.5배 더 어려움)

**장점**:
- 샘플 크기 큼 (9,340개)
- 배당 적당 (평균 6.03배)

**단점**:
- 필요 개선 폭 너무 큼 (+9.6%p)
- 현실적으로 달성 어려움

**결론**: Secondary target (50x+가 안 되면 고려)

---

### ✅ 전략 C: 1-2배 저배당 최적화 (보너스)

**목표**: 현재 +20.1% ROI를 **+30%+**로 개선

**현황**:
- 이미 수익 가능 (53.6% > 44.7%)
- ROI +20.1%

**개선 방향**:
- 추가 필터링으로 55%+ 달성
- 예상 ROI: +32%

**장점**:
- 안정적 (이미 수익 가능)
- 리스크 낮음

**단점**:
- 배당 낮음 (2.80배)
- 샘플 작음 (5,937개)

**결론**: 보조 전략

---

## 8. 다음 단계

### 8.1 Feature Engineering

**Rolling Window 방식** (Look-ahead bias 방지):

```python
# 각 경주 시점 이전 데이터만 사용
for race_date in train_dates:
    historical_data = train[train['trd_dt'] < race_date]

    # 기수 통계 (50배+ 기준)
    jockey_stats_50x = historical_data[
        historical_data['odds_win'] >= 50
    ].groupby('jockey_name')['is_top3'].agg(['mean', 'count'])

    # 조련사 통계
    trainer_stats_50x = historical_data[
        historical_data['odds_win'] >= 50
    ].groupby('trainer_name')['is_top3'].agg(['mean', 'count'])

    # Feature 생성
    features[race_date] = {
        'jockey_top3_rate_50x': jockey_stats_50x['mean'],
        'jockey_count_50x': jockey_stats_50x['count'],
        'trainer_top3_rate_50x': trainer_stats_50x['mean'],
        'trainer_count_50x': trainer_stats_50x['count'],
        ...
    }
```

**핵심 Features**:

1. **기수 통계** (50x+ 기준)
   - `jockey_top3_rate_50x`: Top 3 비율
   - `jockey_count_50x`: 출전 횟수
   - `is_elite_jockey`: 10%+ 여부

2. **조련사 통계** (50x+ 기준)
   - `trainer_top3_rate_50x`: Top 3 비율
   - `trainer_count_50x`: 출전 횟수
   - `is_elite_trainer`: 10%+ 여부

3. **말 특성**
   - `horse_age`: 나이
   - `burden_weight`: 부담중량
   - `gate_no`: 게이트 번호

4. **상호작용**
   - `elite_jockey_trainer`: 엘리트 기수 × 엘리트 조련사

---

### 8.2 모델링

**Option A: Rule-based** (권장)

```python
def predict_50x_top3(row):
    score = 0

    # 엘리트 기수
    if (row['jockey_top3_rate_50x'] >= 0.10 and
        row['jockey_count_50x'] >= 10):
        score += 3

    # 엘리트 조련사
    if (row['trainer_top3_rate_50x'] >= 0.10 and
        row['trainer_count_50x'] >= 10):
        score += 2

    # 부담중량
    if 54 <= row['burden_weight'] <= 56:
        score += 1

    # 나이
    if row['horse_age'] in [3, 4, 5]:
        score += 1

    # 게이트
    if row['gate_no'] <= 3:
        score += 1

    return score >= 4  # 4점 이상 베팅
```

**Option B: LightGBM** (대안)

```python
import lightgbm as lgbm

params = {
    'objective': 'binary',
    'metric': 'auc',
    'learning_rate': 0.05,
    'max_depth': 3,  # 얕게 (과적합 방지)
    'num_leaves': 7,
    'min_data_in_leaf': 100,  # 크게
    'feature_fraction': 0.8,
    'bagging_fraction': 0.8,
}

model = lgbm.train(
    params,
    train_data,
    num_boost_round=100,
    valid_sets=[val_data],
    callbacks=[lgbm.early_stopping(20)]
)
```

---

### 8.3 검증 전략

**Walk-forward Cross-Validation** (Train Set 2013-2023):

```
Fold 1: Train 2013-2015, Test 2016
Fold 2: Train 2013-2016, Test 2017
Fold 3: Train 2013-2017, Test 2018
Fold 4: Train 2013-2018, Test 2019
Fold 5: Train 2013-2019, Test 2020
Fold 6: Train 2013-2020, Test 2021
Fold 7: Train 2013-2021, Test 2022
Fold 8: Train 2013-2022, Test 2023
```

**평가지표**:
1. **Top 3 Precision** (점수 4+ 말들의 Top 3 비율)
2. **Coverage** (점수 4+ 말이 전체의 몇 %?)
3. **ROI** (실제 수익률)

**목표**:
- Precision >= 7.4% (모든 Fold)
- ROI >= 0% (모든 Fold)
- Coverage >= 5% (베팅 기회 충분)

---

### 8.4 최종 검증

**Test Set (2024-2025)** - **1회만 실행!**

```python
# 최종 모델 학습 (Train 2013-2023 전체)
final_model = train(train_data_full)

# Test set 예측 (단 1회!)
test_predictions = final_model.predict(test_data)

# 평가
test_precision = calculate_precision(test_predictions, test_labels)
test_roi = calculate_roi(test_predictions, test_odds)

print(f"Test Precision: {test_precision:.1%}")
print(f"Test ROI: {test_roi:+.1%}")
```

**Success Criteria**:
- ✅ Minimum: Precision >= 7.4%, ROI >= 0%
- 🎯 Target: Precision >= 9.0%, ROI >= 20%
- 🚀 Stretch: Precision >= 10.0%, ROI >= 35%

---

## 📌 요약

### 핵심 발견

1. **시장 효율성**: 매우 높음 (배당 ≈ 실제 확률)
2. **가장 유망한 타겟**: 50배+ 고배당
   - 필요 개선: 단 +2.1%p
   - 평균 배당: 16.86배
   - 샘플: 7,490개 (14%)
3. **강력한 예측 신호**:
   - 엘리트 기수: +10%p
   - 엘리트 조련사: +7%p
   - 부담중량 54-56kg: +1.1%p

### 추천 전략

**Primary: 50배+ Rule-based Model**
- 점수 시스템 (0-8점)
- 임계값: 4점+
- 예상 Precision: 10-15%
- 예상 ROI: +20-40%

### 다음 액션

1. Feature engineering (Rolling window)
2. Rule-based model 구현
3. Walk-forward CV (2016-2023)
4. 하이퍼파라미터 튜닝
5. Test set 최종 검증 (1회만!)

---

**작성일**: 2025-10-01
**데이터**: Train Set 2013-2023 (53,395개)
**Look-ahead Bias**: 완전 제거 ✅
